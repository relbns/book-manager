import{r as n,I as xe,u as he,a as me,h as fe,F as i,j as e,T as je,B as u,R as pe,C as D,e as y,W as U,i as I,f as T,A as ge,L as ye,S as $,b as be,k as E,X as ve}from"./index-D6i2_mw7.js";import{d as l}from"./dayjs.min-DRoIcrpN.js";import{R as we,a as De}from"./SearchOutlined-mO85Crtc.js";import{S}from"./index-BsnJOXdJ.js";import{B as Z}from"./index-Bl0KWgPX.js";import{E as F,S as W}from"./index-CW0DgjGR.js";import{M as Se,R as Ce}from"./DeleteOutlined-LkPfvyBR.js";import{C as Ie,D as M}from"./index-vuQ0XdJ7.js";import{R as Te}from"./WarningOutlined-CagqA3TH.js";import{T as B}from"./index-DNoT0NGo.js";import{R as ke}from"./CheckCircleOutlined-CZx1ba0F.js";import{R as Re}from"./CalendarOutlined-C1fUi4Hn.js";import{R as Le,P as G}from"./EditOutlined-CeYbNXDV.js";import{s as x}from"./index-B1FuN-Wd.js";import{F as Oe}from"./Table-Cj0Q1VJk.js";import"./useClosable-BXMcK-Ci.js";import"./DeleteOutlined-BeRCI4Bf.js";import"./dropdown-pAzaKgwE.js";import"./Pagination-DwL0A_xZ.js";function P(){return P=Object.assign?Object.assign.bind():function(a){for(var o=1;o<arguments.length;o++){var j=arguments[o];for(var h in j)Object.prototype.hasOwnProperty.call(j,h)&&(a[h]=j[h])}return a},P.apply(this,arguments)}const $e=(a,o)=>n.createElement(xe,P({},a,{ref:o,icon:Ie})),Ee=n.forwardRef($e),{Title:Fe,Text:g}=je,{Option:Me}=W,{TextArea:Be}=I,{TabPane:C}=U,Pe=T(Oe)`
  .ant-table-thead > tr > th {
    text-align: right;
  }

  .ant-table-cell {
    text-align: right;
  }

  .overdue-row {
    background-color: #fff1f0;
  }
`,Ne=T(y)`
  margin-bottom: 24px;
`,ze=T.div`
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  margin-bottom: 24px;
`,Ae=T.div`
  display: flex;
  justify-content: flex-end;
  gap: 8px;
`,it=()=>{const{loans:a,books:o,addLoan:j,updateLoan:h,deleteLoan:X,createLoanModel:H}=he(),N=me(),z=fe(),[m]=i.useForm(),[b,J]=n.useState(""),[Q,k]=n.useState(!1),[d,ee]=n.useState(null),[v,te]=n.useState([]),[c,A]=n.useState("all"),[R,w]=n.useState([]),[Ve,V]=n.useState(!1);n.useEffect(()=>{const r=new URLSearchParams(z.search).get("tab");r&&(A(r),L(r))},[z]),n.useEffect(()=>{let t=[...a];if(R.length>0&&(t=t.filter(r=>R.includes(r.status))),b){const r=b.toLowerCase();t=t.filter(s=>{const K=o.find(ue=>ue.id===s.bookId);return(K?K.title.toLowerCase():"").includes(r)||s.borrowerName.toLowerCase().includes(r)||s.borrowerContact&&s.borrowerContact.toLowerCase().includes(r)})}t=t.sort((r,s)=>new Date(s.loanDate)-new Date(r.loanDate)),te(t),V(c==="overdue")},[a,o,b,R,c]);const L=t=>{switch(A(t),t!=="all"?N(`/loans?tab=${t}`,{replace:!0}):N("/loans",{replace:!0}),t){case"active":w(["active"]);break;case"overdue":w(["active"]);break;case"returned":w(["returned"]);break;default:w([])}},re=t=>{const r=o.find(s=>s.id===t);return r?r.title:"לא ידוע"},p=t=>t.status==="active"&&l(t.dueDate).isBefore(l()),se=t=>{if(t.status!=="active")return null;const r=l(t.dueDate),s=l();return r.diff(s,"day")},O=t=>t?l(t).format("DD/MM/YYYY"):"-",q=(t=null)=>{ee(t),t?m.setFieldsValue({...t,loanDate:l(t.loanDate),dueDate:l(t.dueDate),returnDate:t.returnDate?l(t.returnDate):null}):(m.resetFields(),m.setFieldsValue({loanDate:l(),dueDate:l().add(14,"day"),status:"active"})),k(!0)},_=()=>{k(!1),m.resetFields()},ae=async t=>{const r={...t,loanDate:t.loanDate.toISOString(),dueDate:t.dueDate.toISOString(),returnDate:t.returnDate?t.returnDate.toISOString():null,status:t.returnDate?"returned":"active"};try{d?(await h(d.id,r),x.success("ההשאלה עודכנה בהצלחה")):(await j(r),x.success("ההשאלה נוספה בהצלחה")),k(!1),m.resetFields()}catch(s){console.error("Error saving loan:",s),x.error("אירעה שגיאה בשמירת ההשאלה")}},ne=async t=>{try{await X(t),x.success("ההשאלה נמחקה בהצלחה")}catch(r){console.error("Error deleting loan:",r),x.error("אירעה שגיאה במחיקת ההשאלה")}},oe=async t=>{try{await h(t.id,{...t,returnDate:new Date().toISOString(),status:"returned"}),x.success("הספר סומן כמוחזר בהצלחה")}catch(r){console.error("Error returning book:",r),x.error("אירעה שגיאה בעת סימון הספר כמוחזר")}},le=a.length,Y=a.filter(t=>t.status==="active").length,ie=a.filter(t=>t.status==="returned").length,f=a.filter(t=>p(t)).length,ce=[{title:"ספר",dataIndex:"bookId",key:"bookId",render:t=>e.jsx(ye,{to:`/books/${t}`,children:e.jsxs($,{children:[e.jsx(be,{}),e.jsx(g,{strong:!0,children:re(t)})]})})},{title:"שואל",dataIndex:"borrowerName",key:"borrowerName",render:(t,r)=>e.jsxs($,{direction:"vertical",size:0,children:[e.jsx(g,{children:t}),e.jsx(g,{type:"secondary",style:{fontSize:"12px"},children:r.borrowerContact})]})},{title:"תאריך השאלה",dataIndex:"loanDate",key:"loanDate",render:t=>O(t)},{title:"תאריך החזרה",dataIndex:"dueDate",key:"dueDate",render:(t,r)=>e.jsxs($,{direction:"vertical",size:0,children:[e.jsx(g,{children:O(t)}),r.status==="active"&&e.jsx(g,{type:p(r)?"danger":"secondary",style:{fontSize:"12px"},children:(()=>{const s=se(r);return s===null?"":s<0?`באיחור של ${Math.abs(s)} ימים`:`נותרו ${s} ימים`})()})]})},{title:"סטטוס",key:"status",render:(t,r)=>r.status==="returned"?e.jsxs(B,{color:"success",icon:e.jsx(ke,{}),children:["הוחזר"," ",r.returnDate?`ב-${O(r.returnDate)}`:""]}):p(r)?e.jsx(B,{color:"error",icon:e.jsx(Ee,{}),children:"באיחור"}):e.jsx(B,{color:"processing",icon:e.jsx(Re,{}),children:"פעיל"})},{title:"פעולות",key:"actions",width:120,render:(t,r)=>e.jsxs(Ae,{children:[e.jsx(E,{title:"עריכה",children:e.jsx(u,{icon:e.jsx(Le,{}),type:"text",onClick:()=>q(r)})}),r.status==="active"&&e.jsx(E,{title:"החזרת ספר",children:e.jsx(G,{title:"האם להחזיר את הספר?",onConfirm:()=>oe(r),okText:"כן",cancelText:"לא",placement:"topRight",children:e.jsx(u,{icon:e.jsx(ve,{}),type:"text"})})}),e.jsx(E,{title:"מחיקה",children:e.jsx(G,{title:"בטוח שאתה רוצה למחוק את ההשאלה?",onConfirm:()=>ne(r.id),okText:"כן",cancelText:"לא",placement:"topRight",children:e.jsx(u,{icon:e.jsx(Ce,{}),type:"text",danger:!0})})})]})}],de=()=>f===0?null:e.jsx(ge,{message:`יש ${f} ספרים באיחור החזרה`,description:"ספרים שעבר התאריך להחזרתם מודגשים באדום.",type:"warning",showIcon:!0,icon:e.jsx(Te,{}),style:{marginBottom:16},action:c!=="overdue"?e.jsx(u,{size:"small",onClick:()=>L("overdue"),children:"הצג רק ספרים באיחור"}):null});return e.jsxs("div",{children:[e.jsxs(Ne,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[e.jsx(Fe,{level:2,children:"השאלות"}),e.jsx(u,{type:"primary",icon:e.jsx(we,{}),onClick:()=>q(),children:"הוספת השאלה"})]}),e.jsxs(pe,{gutter:[16,16],style:{marginBottom:24},children:[e.jsx(D,{xs:24,sm:12,md:6,children:e.jsx(y,{children:e.jsx(S,{title:"סה״כ השאלות",value:le,valueStyle:{color:"#1890ff"}})})}),e.jsx(D,{xs:24,sm:12,md:6,children:e.jsx(y,{children:e.jsx(S,{title:"השאלות פעילות",value:Y,valueStyle:{color:"#52c41a"}})})}),e.jsx(D,{xs:24,sm:12,md:6,children:e.jsx(y,{children:e.jsx(S,{title:"ספרים שהוחזרו",value:ie,valueStyle:{color:"#722ed1"}})})}),e.jsx(D,{xs:24,sm:12,md:6,children:e.jsx(y,{children:e.jsx(S,{title:"באיחור",value:f,valueStyle:{color:"#f5222d"}})})})]}),e.jsx(de,{}),e.jsxs(U,{activeKey:c,onChange:L,children:[e.jsx(C,{tab:"כל ההשאלות"},"all"),e.jsx(C,{tab:e.jsx(Z,{count:Y,showZero:!0,children:e.jsx("span",{children:"השאלות פעילות"})})},"active"),e.jsx(C,{tab:e.jsx(Z,{count:f,showZero:!0,color:"red",children:e.jsx("span",{children:"באיחור"})})},"overdue"),e.jsx(C,{tab:"הוחזרו"},"returned")]}),e.jsx(ze,{children:e.jsx(I,{placeholder:"חיפוש לפי שם ספר או שם שואל",prefix:e.jsx(De,{}),value:b,onChange:t=>J(t.target.value),style:{width:300}})}),c==="overdue"&&f===0&&e.jsx(F,{description:"אין ספרים באיחור!",image:F.PRESENTED_IMAGE_SIMPLE}),v.length===0&&c!=="overdue"&&e.jsx(F,{description:"לא נמצאו השאלות"}),(v.length>0||c==="overdue"&&f>0)&&e.jsx(Pe,{dataSource:c==="overdue"?v.filter(t=>p(t)):v,columns:ce,rowKey:"id",rowClassName:t=>p(t)?"overdue-row":"",pagination:{pageSize:10,showSizeChanger:!0,showTotal:t=>`סה"כ ${t} השאלות`},locale:{emptyText:"לא נמצאו השאלות"}})]}),e.jsx(Se,{title:d?"עריכת השאלה":"הוספת השאלה חדשה",open:Q,onCancel:_,footer:null,destroyOnClose:!0,width:600,children:e.jsxs(i,{form:m,layout:"vertical",onFinish:ae,initialValues:H(),children:[e.jsx(i.Item,{name:"bookId",label:"ספר",rules:[{required:!0,message:"נא לבחור ספר"}],children:e.jsx(W,{showSearch:!0,placeholder:"בחר ספר",optionFilterProp:"children",filterOption:(t,r)=>r.children.toLowerCase().indexOf(t.toLowerCase())>=0,children:o.map(t=>e.jsx(Me,{value:t.id,children:t.title},t.id))})}),e.jsx(i.Item,{name:"borrowerName",label:"שם השואל",rules:[{required:!0,message:"נא להזין את שם השואל"}],children:e.jsx(I,{placeholder:"הזן את שם השואל"})}),e.jsx(i.Item,{name:"borrowerContact",label:"פרטי קשר",rules:[{required:!0,message:"נא להזין פרטי קשר"}],children:e.jsx(I,{placeholder:"טלפון / אימייל"})}),e.jsxs("div",{style:{display:"flex",gap:16},children:[e.jsx(i.Item,{name:"loanDate",label:"תאריך השאלה",rules:[{required:!0,message:"נא לבחור תאריך השאלה"}],style:{flex:1},children:e.jsx(M,{style:{width:"100%"}})}),e.jsx(i.Item,{name:"dueDate",label:"תאריך החזרה צפוי",rules:[{required:!0,message:"נא לבחור תאריך החזרה צפוי"}],style:{flex:1},children:e.jsx(M,{style:{width:"100%"}})})]}),e.jsx(i.Item,{name:"returnDate",label:"תאריך החזרה בפועל",children:e.jsx(M,{style:{width:"100%"},placeholder:(d==null?void 0:d.status)==="returned"?"בחר תאריך":"השאר ריק אם לא הוחזר"})}),e.jsx(i.Item,{name:"notes",label:"הערות",children:e.jsx(Be,{placeholder:"הערות נוספות",rows:3})}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:16},children:[e.jsx(u,{onClick:_,children:"ביטול"}),e.jsx(u,{type:"primary",htmlType:"submit",children:d?"עדכון":"הוספה"})]})]})})]})};export{it as default};
//# sourceMappingURL=Loans-DNVtM0bn.js.map
