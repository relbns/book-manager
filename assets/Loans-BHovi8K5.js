import{r as n,I as xe,u as he,a as me,i as fe,F as i,j as e,T as pe,B as u,R as je,C as D,e as y,X as U,k as I,f as T,A as ge,L as ye,S as $,b as be,l as E,Y as ve}from"./index-BZbfShRi.js";import{d as l}from"./dayjs.min-DwegfA2E.js";import{R as we,a as De,b as Se}from"./ResponsiveFilterContainer-D2Div_md.js";import{S}from"./index-Cx84pAS7.js";import{B as Z}from"./index-DwY1pzy3.js";import{E as F,S as X}from"./index-CGmZKCwg.js";import{M as Ce,R as Ie}from"./DeleteOutlined-DwOr8z1T.js";import{C as Te,D as M}from"./index-6liAhSc1.js";import{R as Re}from"./WarningOutlined-ay4n_I7C.js";import{T as B}from"./index-B4W8rN_h.js";import{R as ke}from"./CheckCircleOutlined-iU1XYHnz.js";import{R as Le}from"./CalendarOutlined-wmm4J3ul.js";import{R as Oe,P as G}from"./EditOutlined-D8uqvWcn.js";import{s as x}from"./index-BFYnWxa_.js";import{F as $e}from"./Table-DM0GOEUw.js";import"./useClosable-gFP0jpH6.js";import"./DeleteOutlined-DZl07uw-.js";import"./dropdown-BlGPvsQt.js";import"./Pagination-B4h8omi_.js";function P(){return P=Object.assign?Object.assign.bind():function(a){for(var o=1;o<arguments.length;o++){var p=arguments[o];for(var h in p)Object.prototype.hasOwnProperty.call(p,h)&&(a[h]=p[h])}return a},P.apply(this,arguments)}const Ee=(a,o)=>n.createElement(xe,P({},a,{ref:o,icon:Te})),Fe=n.forwardRef(Ee),{Title:Me,Text:g}=pe,{Option:Be}=X,{TextArea:Pe}=I,{TabPane:C}=U,Ne=T($e)`
  .ant-table-thead > tr > th {
    text-align: right;
  }

  .ant-table-cell {
    text-align: right;
  }

  .overdue-row {
    background-color: #fff1f0;
  }
`,ze=T(y)`
  margin-bottom: 24px;
`;T.div`
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  margin-bottom: 24px;
`;const Ae=T.div`
  display: flex;
  justify-content: flex-end;
  gap: 8px;
`,it=()=>{const{loans:a,books:o,addLoan:p,updateLoan:h,deleteLoan:H,createLoanModel:J}=he(),N=me(),z=fe(),[m]=i.useForm(),[b,Q]=n.useState(""),[W,R]=n.useState(!1),[d,ee]=n.useState(null),[v,te]=n.useState([]),[c,A]=n.useState("all"),[k,w]=n.useState([]),[Ve,V]=n.useState(!1);n.useEffect(()=>{const r=new URLSearchParams(z.search).get("tab");r&&(A(r),L(r))},[z]),n.useEffect(()=>{let t=[...a];if(k.length>0&&(t=t.filter(r=>k.includes(r.status))),b){const r=b.toLowerCase();t=t.filter(s=>{const K=o.find(ue=>ue.id===s.bookId);return(K?K.title.toLowerCase():"").includes(r)||s.borrowerName.toLowerCase().includes(r)||s.borrowerContact&&s.borrowerContact.toLowerCase().includes(r)})}t=t.sort((r,s)=>new Date(s.loanDate)-new Date(r.loanDate)),te(t),V(c==="overdue")},[a,o,b,k,c]);const L=t=>{switch(A(t),t!=="all"?N(`/loans?tab=${t}`,{replace:!0}):N("/loans",{replace:!0}),t){case"active":w(["active"]);break;case"overdue":w(["active"]);break;case"returned":w(["returned"]);break;default:w([])}},re=t=>{const r=o.find(s=>s.id===t);return r?r.title:"לא ידוע"},j=t=>t.status==="active"&&l(t.dueDate).isBefore(l()),se=t=>{if(t.status!=="active")return null;const r=l(t.dueDate),s=l();return r.diff(s,"day")},O=t=>t?l(t).format("DD/MM/YYYY"):"-",q=(t=null)=>{ee(t),t?m.setFieldsValue({...t,loanDate:l(t.loanDate),dueDate:l(t.dueDate),returnDate:t.returnDate?l(t.returnDate):null}):(m.resetFields(),m.setFieldsValue({loanDate:l(),dueDate:l().add(14,"day"),status:"active"})),R(!0)},Y=()=>{R(!1),m.resetFields()},ae=async t=>{const r={...t,loanDate:t.loanDate.toISOString(),dueDate:t.dueDate.toISOString(),returnDate:t.returnDate?t.returnDate.toISOString():null,status:t.returnDate?"returned":"active"};try{d?(await h(d.id,r),x.success("ההשאלה עודכנה בהצלחה")):(await p(r),x.success("ההשאלה נוספה בהצלחה")),R(!1),m.resetFields()}catch(s){console.error("Error saving loan:",s),x.error("אירעה שגיאה בשמירת ההשאלה")}},ne=async t=>{try{await H(t),x.success("ההשאלה נמחקה בהצלחה")}catch(r){console.error("Error deleting loan:",r),x.error("אירעה שגיאה במחיקת ההשאלה")}},oe=async t=>{try{await h(t.id,{...t,returnDate:new Date().toISOString(),status:"returned"}),x.success("הספר סומן כמוחזר בהצלחה")}catch(r){console.error("Error returning book:",r),x.error("אירעה שגיאה בעת סימון הספר כמוחזר")}},le=a.length,_=a.filter(t=>t.status==="active").length,ie=a.filter(t=>t.status==="returned").length,f=a.filter(t=>j(t)).length,ce=[{title:"ספר",dataIndex:"bookId",key:"bookId",render:t=>e.jsx(ye,{to:`/books/${t}`,children:e.jsxs($,{children:[e.jsx(be,{}),e.jsx(g,{strong:!0,children:re(t)})]})})},{title:"שואל",dataIndex:"borrowerName",key:"borrowerName",render:(t,r)=>e.jsxs($,{direction:"vertical",size:0,children:[e.jsx(g,{children:t}),e.jsx(g,{type:"secondary",style:{fontSize:"12px"},children:r.borrowerContact})]})},{title:"תאריך השאלה",dataIndex:"loanDate",key:"loanDate",render:t=>O(t)},{title:"תאריך החזרה",dataIndex:"dueDate",key:"dueDate",render:(t,r)=>e.jsxs($,{direction:"vertical",size:0,children:[e.jsx(g,{children:O(t)}),r.status==="active"&&e.jsx(g,{type:j(r)?"danger":"secondary",style:{fontSize:"12px"},children:(()=>{const s=se(r);return s===null?"":s<0?`באיחור של ${Math.abs(s)} ימים`:`נותרו ${s} ימים`})()})]})},{title:"סטטוס",key:"status",render:(t,r)=>r.status==="returned"?e.jsxs(B,{color:"success",icon:e.jsx(ke,{}),children:["הוחזר"," ",r.returnDate?`ב-${O(r.returnDate)}`:""]}):j(r)?e.jsx(B,{color:"error",icon:e.jsx(Fe,{}),children:"באיחור"}):e.jsx(B,{color:"processing",icon:e.jsx(Le,{}),children:"פעיל"})},{title:"פעולות",key:"actions",width:120,render:(t,r)=>e.jsxs(Ae,{children:[e.jsx(E,{title:"עריכה",children:e.jsx(u,{icon:e.jsx(Oe,{}),type:"text",onClick:()=>q(r)})}),r.status==="active"&&e.jsx(E,{title:"החזרת ספר",children:e.jsx(G,{title:"האם להחזיר את הספר?",onConfirm:()=>oe(r),okText:"כן",cancelText:"לא",placement:"topRight",children:e.jsx(u,{icon:e.jsx(ve,{}),type:"text"})})}),e.jsx(E,{title:"מחיקה",children:e.jsx(G,{title:"בטוח שאתה רוצה למחוק את ההשאלה?",onConfirm:()=>ne(r.id),okText:"כן",cancelText:"לא",placement:"topRight",children:e.jsx(u,{icon:e.jsx(Ie,{}),type:"text",danger:!0})})})]})}],de=()=>f===0?null:e.jsx(ge,{message:`יש ${f} ספרים באיחור החזרה`,description:"ספרים שעבר התאריך להחזרתם מודגשים באדום.",type:"warning",showIcon:!0,icon:e.jsx(Re,{}),style:{marginBottom:16},action:c!=="overdue"?e.jsx(u,{size:"small",onClick:()=>L("overdue"),children:"הצג רק ספרים באיחור"}):null});return e.jsxs("div",{children:[e.jsxs(ze,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[e.jsx(Me,{level:2,children:"השאלות"}),e.jsx(u,{type:"primary",icon:e.jsx(we,{}),onClick:()=>q(),children:"הוספת השאלה"})]}),e.jsxs(je,{gutter:[16,16],style:{marginBottom:24},children:[e.jsx(D,{xs:24,sm:12,md:6,children:e.jsx(y,{children:e.jsx(S,{title:"סה״כ השאלות",value:le,valueStyle:{color:"#1890ff"}})})}),e.jsx(D,{xs:24,sm:12,md:6,children:e.jsx(y,{children:e.jsx(S,{title:"השאלות פעילות",value:_,valueStyle:{color:"#52c41a"}})})}),e.jsx(D,{xs:24,sm:12,md:6,children:e.jsx(y,{children:e.jsx(S,{title:"ספרים שהוחזרו",value:ie,valueStyle:{color:"#722ed1"}})})}),e.jsx(D,{xs:24,sm:12,md:6,children:e.jsx(y,{children:e.jsx(S,{title:"באיחור",value:f,valueStyle:{color:"#f5222d"}})})})]}),e.jsx(de,{}),e.jsxs(U,{activeKey:c,onChange:L,children:[e.jsx(C,{tab:"כל ההשאלות"},"all"),e.jsx(C,{tab:e.jsx(Z,{count:_,showZero:!0,children:e.jsx("span",{children:"השאלות פעילות"})})},"active"),e.jsx(C,{tab:e.jsx(Z,{count:f,showZero:!0,color:"red",children:e.jsx("span",{children:"באיחור"})})},"overdue"),e.jsx(C,{tab:"הוחזרו"},"returned")]}),e.jsx(De,{children:e.jsx(I,{placeholder:"חיפוש לפי שם ספר או שם שואל",prefix:e.jsx(Se,{}),value:b,onChange:t=>Q(t.target.value),style:{width:300}})}),c==="overdue"&&f===0&&e.jsx(F,{description:"אין ספרים באיחור!",image:F.PRESENTED_IMAGE_SIMPLE}),v.length===0&&c!=="overdue"&&e.jsx(F,{description:"לא נמצאו השאלות"}),(v.length>0||c==="overdue"&&f>0)&&e.jsx(Ne,{dataSource:c==="overdue"?v.filter(t=>j(t)):v,columns:ce,rowKey:"id",rowClassName:t=>j(t)?"overdue-row":"",pagination:{pageSize:10,showSizeChanger:!0,showTotal:t=>`סה"כ ${t} השאלות`},locale:{emptyText:"לא נמצאו השאלות"}})]}),e.jsx(Ce,{title:d?"עריכת השאלה":"הוספת השאלה חדשה",open:W,onCancel:Y,footer:null,destroyOnClose:!0,width:600,children:e.jsxs(i,{form:m,layout:"vertical",onFinish:ae,initialValues:J(),children:[e.jsx(i.Item,{name:"bookId",label:"ספר",rules:[{required:!0,message:"נא לבחור ספר"}],children:e.jsx(X,{showSearch:!0,placeholder:"בחר ספר",optionFilterProp:"children",filterOption:(t,r)=>r.children.toLowerCase().indexOf(t.toLowerCase())>=0,children:o.map(t=>e.jsx(Be,{value:t.id,children:t.title},t.id))})}),e.jsx(i.Item,{name:"borrowerName",label:"שם השואל",rules:[{required:!0,message:"נא להזין את שם השואל"}],children:e.jsx(I,{placeholder:"הזן את שם השואל"})}),e.jsx(i.Item,{name:"borrowerContact",label:"פרטי קשר",rules:[{required:!0,message:"נא להזין פרטי קשר"}],children:e.jsx(I,{placeholder:"טלפון / אימייל"})}),e.jsxs("div",{style:{display:"flex",gap:16},children:[e.jsx(i.Item,{name:"loanDate",label:"תאריך השאלה",rules:[{required:!0,message:"נא לבחור תאריך השאלה"}],style:{flex:1},children:e.jsx(M,{style:{width:"100%"}})}),e.jsx(i.Item,{name:"dueDate",label:"תאריך החזרה צפוי",rules:[{required:!0,message:"נא לבחור תאריך החזרה צפוי"}],style:{flex:1},children:e.jsx(M,{style:{width:"100%"}})})]}),e.jsx(i.Item,{name:"returnDate",label:"תאריך החזרה בפועל",children:e.jsx(M,{style:{width:"100%"},placeholder:(d==null?void 0:d.status)==="returned"?"בחר תאריך":"השאר ריק אם לא הוחזר"})}),e.jsx(i.Item,{name:"notes",label:"הערות",children:e.jsx(Pe,{placeholder:"הערות נוספות",rows:3})}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:16},children:[e.jsx(u,{onClick:Y,children:"ביטול"}),e.jsx(u,{type:"primary",htmlType:"submit",children:d?"עדכון":"הוספה"})]})]})})]})};export{it as default};
//# sourceMappingURL=Loans-BHovi8K5.js.map
